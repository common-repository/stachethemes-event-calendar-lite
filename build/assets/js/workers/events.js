function EventsWorker(t){this.params=t}EventsWorker.prototype._getUtcOffsetInHours=function(t){const e=moment.utc(t.initial_start_date_utc);return moment.utc(t.meta.start_date).diff(e,"minutes")/60},EventsWorker.prototype._ensureInitialDates=function(t){return t.initial_start_date&&(t.meta.start_date=t.initial_start_date,t.meta.end_date=t.initial_end_date,t.meta.start_date_utc=t.initial_start_date_utc,t.meta.end_date_utc=t.initial_end_date_utc),t.initial_start_date||(t.initial_start_date=t.meta.start_date,t.initial_end_date=t.meta.end_date,t.initial_start_date_utc=t.meta.start_date_utc,t.initial_end_date_utc=t.meta.end_date_utc),t},EventsWorker.prototype._getDateOccurences=function({event:t,rangeEndMoment:e}){const{rrulestr:a}=rrule,r=moment.utc(t.meta.start_date);let s=`DTSTART;TZID=UTC:${r.format("YYYYMMDDTHHmmss")}\nRRULE:${t.meta.rrule}`.replace(/;(\s+)?$/,"");if(Array.isArray(t.meta.exdate)&&t.meta.exdate.length>0){const e=[],a=`${r.format("HHmm")}00Z`;t.meta.exdate.forEach((r=>{const s=moment.tz(r,t.meta.timezone);s.isValid()&&e.push(`${s.format("YYYYMMDD")}T${a}`)})),s+=`\nEXDATE:${e.join(",")}`}const n=a(s),o=moment(e).add(1,"day");return n.between(moment.utc(t.meta.start_date).toDate(),o.toDate(),!0).map((t=>moment.utc(t).format("YYYY-MM-DD HH:mm:ss")))},EventsWorker.prototype._getEventDurationInMinutes=function(t){const e=moment.utc(t.initial_start_date);return moment.utc(t.initial_end_date).diff(e,"minutes")},EventsWorker.prototype._getEventOccurences=function({event:t,rangeEndMoment:e}){const a=[];if(t.meta.rrule)try{const r=this._getDateOccurences({event:t,rangeEndMoment:e}),s=this._getEventDurationInMinutes(t);for(let e in r){const n=JSON.parse(JSON.stringify(t)),o="YYYY-MM-DDTHH:mm",i=r[e],m=moment.tz(i,t.meta.timezone),c=moment.tz(i,t.meta.timezone).utc(),d=moment.utc(i).add(s,"minutes").format(o),l=moment.tz(d,t.meta.timezone),u=moment.tz(d,t.meta.timezone).utc(),f=c.diff(moment.utc(n.initial_start_date_utc),"seconds");n.meta.start_date=m.format(o),n.meta.start_date_utc=c.format(o),n.meta.end_date_utc=u.format(o),n.meta.end_date=l.format(o),n.repeat_offset=f,a.push(n)}}catch(e){a.push(t)}else a.push(t);return a},EventsWorker.prototype._checkEventEndingInBeginRangeStart=function(t,e){const a=e||this.params.startRange;if(!1===this.params.showInUserTimezone){const e=moment.utc(a),r=moment.utc(t.meta.end_date);return 0===r.hour()&&0===r.minute()&&e.isSame(r)}const r=moment.utc(a).local(),s=moment.tz(t.meta.end_date,t.meta.timezone).local();return 0===s.hour()&&0===s.minute()&&r.isSame(s)},EventsWorker.prototype.getEventsBetween=function(){const t=moment.utc(this.params.startRange),e=moment.utc(this.params.endRange),a=!1===this.params.showInUserTimezone,r=[];let s=[];for(let s in this.params.events){let n=this.params.events[s];n=JSON.parse(JSON.stringify(n)),n=this._ensureInitialDates(n);const o=n,i=this._getEventOccurences({event:o,rangeEndMoment:e});for(let s in i){const n=i[s],o=moment.utc(n.meta.start_date_utc),m=moment.utc(n.meta.end_date_utc),c=a?moment.utc(n.meta.start_date):moment.utc(n.meta.start_date_utc),d=a?moment.utc(n.meta.end_date):moment.utc(n.meta.end_date_utc),l=c.unix(),u=d.unix(),f=t.unix();if(e.unix()>=l&&u>=f){let t=!0;const e=this.params.minMaxIntersect;if(!0===this._checkEventEndingInBeginRangeStart(n,this.params.startRange)&&(t=!1),t&&this.params.minDate){const a=moment.utc(this.params.minDate);e?m.isBefore(a)&&(t=!1):o.isBefore(a)&&(t=!1)}if(t&&this.params.maxDate){const e=moment.utc(this.params.maxDate);o.isAfter(e)&&(t=!1)}if(Array.isArray(this.params.filters)&&this.params.filters.length>0)for(let e in this.params.filters){if(!1===t)break;const a=this.params.filters[e];switch(a.id){case"calendars":{const e=n.calendar.id;!1===a.items.some((t=>t.id===e&&!0===t.active))&&(t=!1);break}case"locations":t=n.location&&n.location.id?a.items.some((t=>t.id===n.location.id&&t.active)):a.items.some((t=>0===t.id&&t.active));break;case"guests":case"organizers":case"categories":{const{id:e}=a;if(!1===Array.isArray(n[e]))break;const r=a.items.filter((t=>t.active)).map((t=>t.id));if(!n[e].some((t=>r.includes(t.id)))){const a=r.includes(0),s=!n[e].length;a&&s||(t=!1)}break}}}t&&r.push(n)}}}if(!Array.isArray(r)||r.length<=0)return[];const n=r.filter((t=>!!t.meta.recurrence_id));for(let t in n){const e=n[t];let a=moment.utc(e.meta.recurrence_id).format("YYYYMMDD");"19700101"===a&&(a=moment.utc(e.meta.start_date).format("YYYYMMDD"));const s=e.meta.uid;for(let t=0;t<r.length;t++){const e=moment.utc(r[t].meta.start_date).format("YYYYMMDD");r[t].meta.recurrence_id||e!==a||r[t].meta.uid!==s||r.splice(t,1)}}const o=r.sort(((t,e)=>{if("id"===this.params.orderby)return"desc"===this.params.order?e.id-t.id:t.id-e.id;let a=moment.utc(t.meta.start_date_utc),r=moment.utc(e.meta.start_date_utc);const s=a.diff(r);return"desc"===this.params.order?0===s?e.id-t.id:-s:0===s?t.id-e.id:s}));if(!0===this.params.sortEventsInYMDkeys){const a=!1===this.params.showInUserTimezone,r={},n=this.params.dow,i=a?moment.utc(t):moment.utc(t).local(),m=a?moment.utc(e):moment.utc(e).local(),c=7;let d=0;if(n!==i.day()){const t=(i.day()-n+7)%7;d+=t}for(;i.isBefore(m);){const t=i.format("YYYY-MM-DD");r[t]=[],o.forEach((e=>{const s=a?moment.utc(e.meta.start_date):moment.utc(e.meta.start_date_utc).local(),n=a?moment.utc(e.meta.end_date):moment.utc(e.meta.end_date_utc).local();e.local_start=s.format("DD,MMM HH:mm"),e.local_end=n.format("DD,MMM HH:mm");const o=i.isBetween(s,n,"day","[]"),m=this._checkEventEndingInBeginRangeStart(e,i);if(o&&!m){if(d%c==0&&(e.pos=void 0),void 0===e.pos){const a=r[t][r[t].length-1];if(void 0!==a?.pos){const a=r[t].map((t=>t.pos));let s=0;for(;a.includes(s);)s++;e.pos=s}else e.pos=0}r[t].push({...e})}})),d++,i.add(1,"day")}for(let t in r)r[t].sort(((t,e)=>t.pos-e.pos));s=r}else s=o;if(!0===this.params.sortEventsForDayHourlyLayout&&(s=this.__getDayEventsHourly(s)),this.params.limit&&(s=s.slice(0,this.params.limit)),void 0!==this.params.stecFilterGetWorkerEventsBetween)try{s=new Function(this.params.stecFilterGetWorkerEventsBetween)()(s,this.params)}catch(t){}return s},EventsWorker.prototype.getEventsFilters=function(){const t=this.params.events;return!1===Array.isArray(t)||t.length<=0?[]:(t.forEach((t=>{for(let e in this.params.filters){const a=this.params.filters[e];switch(a.id){case"calendars":if(!t.calendar)break;!1===a.items.some((e=>e.id===t.calendar.id))&&a.items.push({id:t.calendar.id,label:t.calendar.title,color:t.calendar.color,timezone:t.calendar.timezone,active:!0});break;case"categories":if(!1===Array.isArray(t.categories)||t.categories.length<=0)break;t.categories.forEach((t=>{!1===a.items.some((e=>e.id===t.id))&&a.items.push({id:t.id,label:t.title,color:t.color,active:a.defaultActiveValue})}));break;case"locations":if(!t.location)break;!1===a.items.some((e=>e.id===t.location.id))&&a.items.push({id:t.location.id,label:t.location.title,color:t.location.color,active:!0});break;case"organizers":if(!1===Array.isArray(t.organizers)||t.organizers.length<=0)break;t.organizers.forEach((t=>{!1===a.items.some((e=>e.id===t.id))&&a.items.push({id:t.id,label:t.title,color:t.color,active:!0})}));break;case"guests":if(!1===Array.isArray(t.guests)||t.guests.length<=0)break;t.guests.forEach((t=>{!1===a.items.some((e=>e.id===t.id))&&a.items.push({id:t.id,label:t.title,color:t.color,active:!0})}))}}})),this.params.filters.forEach((t=>{t.items.sort(((t,e)=>0===t.id?-1:0===e.id?1:t.label.localeCompare(e.label)))})),this.params.filters)},EventsWorker.prototype.getWorkerEventsSearchByText=function(){const t=this.params.searchText,e=this.params.events,a=[];for(let r in e){if(a.length>=10)break;const s=e[r],n=[s.title];s.calendar&&s.calendar.title&&n.push(s.calendar.title),s.location&&s.location.title&&n.push(s.location.title),Array.isArray(s.categories)&&s.categories.length>0&&s.categories.forEach((t=>{n.push(t.title)})),Array.isArray(s.organizers)&&s.organizers.length>0&&s.organizers.forEach((t=>{n.push(t.title)})),Array.isArray(s.guests)&&s.guests.length>0&&s.guests.forEach((t=>{n.push(t.title)})),n.forEach(((t,e)=>{n[e]=t.toString().toLowerCase()}));const o=t.toLowerCase();n.some((t=>t.toLowerCase().includes(o)))&&a.push(s)}return a.length>0&&this.params.startRange&&this.params.endRange?(this.params.events=a,this.getEventsBetween()):a},EventsWorker.prototype.__overlaps=(t,e,a)=>{if(a){const a=moment.tz(t.meta.start_date,t.meta.timezone),r=moment.tz(t.meta.end_date,t.meta.timezone),s=moment.tz(e.meta.start_date,e.meta.timezone),n=moment.tz(e.meta.end_date,e.meta.timezone);return a.isBefore(n)&&r.isAfter(s)}{const a=moment.utc(t.meta.start_date),r=moment.utc(t.meta.end_date),s=moment.utc(e.meta.start_date),n=moment.utc(e.meta.end_date);return a.isBefore(n)&&r.isAfter(s)}},EventsWorker.prototype.__getNotAllDayEvents=(t,e)=>t.filter((t=>{if(e.showInUserTimezone){const a=moment(e.calendarDate),r=moment.tz(t.meta.start_date,t.meta.timezone),s=moment.tz(t.meta.end_date,t.meta.timezone);t.meta.all_day&&(r.startOf("day"),s.endOf("day")),r.local(),s.local();return!(r.isSameOrBefore(a.startOf("day"))&&s.isSameOrAfter(a.endOf("day")))}{const a=moment.utc(e.calendarDate),r=moment.utc(t.meta.start_date),s=moment.utc(t.meta.end_date);t.meta.all_day&&(r.startOf("day"),s.endOf("day"));return!(r.isSameOrBefore(a.startOf("day"))&&s.isSameOrAfter(a.endOf("day")))}})),EventsWorker.prototype.__getEventsWithLanes=function(t,e){let a=[],r=JSON.parse(JSON.stringify(t));for(let t of r){let r;for(let s=0;s<a.length;s++)if(!a[s].some((a=>this.__overlaps(a,t,e.showInUserTimezone)))){r=a[s];break}r||(r=[],a.push(r)),r.push(t)}for(let t of a)for(let e of t){let r=a.indexOf(t);e.calcLeft=r/a.length*100,e.calcWidth=1/a.length*100}return r},EventsWorker.prototype.__getDayEventsHourly=function(t){const e=this.params.calendarDate,a=this.params.showInUserTimezone,r=Array.from({length:24},((t,e)=>e));let s=[];s=this.__getNotAllDayEvents(t,{showInUserTimezone:a,calendarDate:e}),s=this.__getEventsWithLanes(s,{showInUserTimezone:a}),s=r.map((t=>{if(a){const a=moment(e).startOf("day").add(t,"hours");return s.filter((e=>{const r=moment.tz(e.meta.start_date,e.meta.timezone),s=moment.tz(e.meta.end_date,e.meta.timezone);e.meta.all_day&&(r.startOf("day"),s.endOf("day")),r.local(),s.local();const n=r.isBefore(a,"day"),o=r.isSame(a,"hour");return(0!==a.hour()||!a.isSameOrAfter(s))&&(!!o||!(0!==t||!n))}))}{const a=moment.utc(e).startOf("day").add(t,"hours");return s.filter((e=>{const r=moment.utc(e.meta.start_date),s=moment.utc(e.meta.end_date);e.meta.all_day&&(r.startOf("day"),s.endOf("day"));const n=r.isBefore(a,"day"),o=r.isSame(a,"hour");return(0!==a.hour()||!a.isSameOrAfter(s))&&(!!o||!(0!==t||!n))}))}}));return{TopEvents:t.filter((t=>{if(a){const a=moment(e).startOf("day"),r=moment.tz(t.meta.start_date,t.meta.timezone),s=moment.tz(t.meta.end_date,t.meta.timezone);return t.meta.all_day&&(r.startOf("day"),s.endOf("day")),!(!r.isSameOrBefore(a.startOf("day"))||!s.isSameOrAfter(a.endOf("day")))}const r=moment.utc(e).startOf("day"),s=moment.utc(t.meta.start_date),n=moment.utc(t.meta.end_date);return t.meta.all_day&&(s.startOf("day"),n.endOf("day")),!(!s.isSameOrBefore(r.startOf("day"))||!n.isSameOrAfter(r.endOf("day")))})),CellEvents:s}},onmessage=t=>{switch(t.data.depScripts&&Array.isArray(t.data.depScripts)&&t.data.depScripts.forEach((t=>{importScripts(t)})),t.data.task){case"getEventsBetween":{const e=new EventsWorker(t.data.params).getEventsBetween();postMessage(e);break}case"getEventsFilters":{const e=new EventsWorker(t.data.params).getEventsFilters();postMessage(e);break}case"getWorkerEventsSearchByText":{const e=new EventsWorker(t.data.params).getWorkerEventsSearchByText();postMessage(e);break}default:postMessage("")}};